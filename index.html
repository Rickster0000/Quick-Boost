<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Boost</title>
  
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="theme-color" content="#3B71F6">

  <style>
    /* --- NEW CLEAN UI UPGRADE --- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', sans-serif;
      background: #3B71F6; 
      color: #ffffff;
      overflow: hidden;
    }

    .app-container { display: flex; flex-direction: column; height: 100%; }
    
    .content-area {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding-bottom: 120px; 
    }

    /* Screens */
    .screen { display: none; width: 100%; max-width: 450px; text-align: center; margin: 0 auto; margin-top: 20px;}
    .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
    #screen-workout { height: 100%; display: none; flex-direction: column; justify-content: center; margin-top:0;}
    #screen-workout.active { display: flex; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Typography */
    h1 { font-size: 3rem; font-weight: 800; margin-bottom: 5px; color: #ffffff; }
    h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; color: #ffffff; }
    .sub-title { font-size: 1rem; font-weight: 500; color: rgba(255,255,255,0.9); margin-bottom: 30px; }
    h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; margin-top: 30px; color: #ffffff; text-align: left; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;}

    /* Workout Cards */
    .workout-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      cursor: pointer;
      border: none;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .workout-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .workout-card:active { transform: scale(0.98); }

    .icon-box {
      width: 50px; height: 50px;
      background: #e0eaff;
      border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      color: #3B71F6; 
      flex-shrink: 0;
    }

    .card-text { text-align: left; width: 100%; }
    .card-title { font-size: 1.1rem; font-weight: 700; color: #3B71F6; }
    .card-sub { font-size: 0.85rem; color: #64748b; font-weight: 500; margin-top: 3px; }

    /* Home Screen Big Icon */
    .home-hero-icon {
      width: 80px; height: 80px;
      background: #ffffff;
      border-radius: 24px;
      display: flex; align-items: center; justify-content: center;
      color: #3B71F6;
      margin: 40px auto 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden; /* Added to keep the image inside the rounded corners */
    }
    .home-hero-icon img { width: 100%; height: 100%; object-fit: cover; }

    /* Inputs */
    input[type="text"], input[type="number"], input[type="time"], input[type="email"], input[type="password"], select {
      background: #f8fafc; border: 1px solid #cbd5e1;
      color: #1e293b; font-size: 1rem; font-family: 'Inter', sans-serif; font-weight: 500;
      padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box;
      margin-bottom: 15px; outline: none; transition: 0.2s;
    }
    input::placeholder { color: #94a3b8; }
    input:focus, select:focus { border-color: #3B71F6; background: #ffffff; box-shadow: 0 0 0 3px rgba(59, 113, 246, 0.2); }
    
    .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .input-row div { flex: 1; text-align: left;}
    .input-row label { font-size: 0.8rem; color: #64748b; margin-left: 5px; font-weight: 600;}

    /* General Buttons */
    .white-btn {
      background: #ffffff; color: #3B71F6; font-size: 1.1rem; font-weight: 700;
      padding: 18px 30px; border-radius: 16px; cursor: pointer; border: none;
      width: 100%; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
      transition: all 0.2s ease;
    }
    .white-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); }
    .white-btn:active { transform: scale(0.97); }

    .outline-btn { background: transparent !important; border: 2px solid #ffffff !important; color: #ffffff !important; box-shadow: none !important; }
    .outline-btn:hover { background: rgba(255, 255, 255, 0.1) !important; }
    
    .danger-btn { background: #fee2e2 !important; color: #ef4444 !important; border: none !important; box-shadow: none !important; }

    /* Standard List Items */
    .list-item {
      background: #ffffff; color: #1e293b; padding: 15px; border-radius: 16px; 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 10px; text-align: left; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .list-item-title { font-weight: 700; font-size: 1rem; color: #3B71F6; }
    .list-item-sub { font-size: 0.8rem; color: #64748b; font-weight: 500;}

    .icon-btn { 
      background: #f1f5f9; border: none; color: #3B71F6; border-radius: 8px; 
      width: 36px; height: 36px; font-size: 1rem; cursor: pointer; transition: 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:hover { background: #e2e8f0; }
    .icon-danger { color: #ef4444; background: #fee2e2; }
    .action-group { display: flex; gap: 5px; }

    /* Dashboard & Calendar */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .stat-card { background: #ffffff; border-radius: 16px; padding: 20px 10px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .stat-value { font-size: 1.8rem; font-weight: 800; color: #3B71F6; margin-bottom: 5px; min-height: 40px; display: flex; align-items: center; justify-content: center; line-height: 1.1; }
    .stat-label { font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; }

    .streak-banner { 
      background: #ffffff; color: #3B71F6; padding: 20px; border-radius: 16px; 
      margin-bottom: 25px; font-weight: 800; font-size: 1.4rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .calendar { background: #ffffff; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); color: #1e293b; }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 700; font-size: 1.2rem; }
    .cal-nav-btn { background: #f1f5f9; border-radius: 8px; border: none; color: #3B71F6; padding: 5px 15px; cursor: pointer; font-weight: bold;}
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
    .cal-day-name { font-weight: 600; font-size: 0.8rem; color: #94a3b8; margin-bottom: 5px; }
    .cal-day { height: 40px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 10px; font-size: 0.95rem; font-weight: 600;}
    .cal-day.empty { background: transparent; }
    .cal-day.logged { background: #3B71F6; color: #ffffff; box-shadow: 0 4px 10px rgba(59, 113, 246, 0.3); }

    /* Settings Rows */
    .settings-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; }
    .settings-label { font-weight: 600; font-size: 0.95rem; text-align: left; color: #ffffff;}
    .settings-sub { font-size: 0.75rem; color: rgba(255,255,255,0.7); font-weight: 500;}

    /* Toggle Switch */
    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.3); transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #F2EE0C; }
    input:checked + .slider:before { transform: translateX(22px); }

    /* Floating Bottom Navigation */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 400px; background: #ffffff;
      border: 1px solid #e2e8f0; display: flex; justify-content: space-around;
      padding: 12px 0; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100;
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-weight: 600; 
      cursor: pointer; font-size: 0.75rem; background: none; border: none; padding: 5px 10px; transition: color 0.3s;
    }
    .nav-item:hover, .nav-item.active { color: #3B71F6; }
    .nav-icon { width: 24px; height: 24px; margin-bottom: 4px; display: block; }

    /* Workout Screen Specifics */
    .top-bar { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; margin-bottom: 40px; width: 100%; color: rgba(255,255,255,0.8); }
    .exercise-title { font-size: 2.5rem; font-weight: 800; margin-bottom: 5px; min-height: 50px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .timer-display { font-size: 8rem; font-weight: 800; margin: 20px 0 50px; color: #ffffff; text-shadow: 0 4px 20px rgba(0,0,0,0.1); font-variant-numeric: tabular-nums; line-height: 1; }
    .controls { display: flex; justify-content: space-between; gap: 15px; width: 100%; }
    .control-btn {
      flex: 1; background: rgba(255, 255, 255, 0.2); color: #ffffff;
      border: none; padding: 18px 10px; border-radius: 16px;
      font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.2s;
    }
    .control-btn:hover { background: rgba(255, 255, 255, 0.3); }

    /* Modals */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
    .modal-content { 
      background: #ffffff; color: #1e293b;
      padding: 30px; border-radius: 24px; text-align: center; width: 90%; max-width: 400px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 85vh; display: flex; flex-direction: column;
    }
    .modal-scroll { overflow-y: auto; flex: 1; margin-bottom: 15px; text-align: left; padding-right: 5px;}
    .modal-content h2 { margin-top: 0; color: #3B71F6; margin-bottom: 15px; }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent;}
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px;}
  </style>
</head>
<body>

  <div class="app-container">
    <div class="content-area">

      <div id="screen-login" class="screen active">
        <div class="home-hero-icon" style="margin-bottom: 20px;">
          <img src="./icon-192.png" alt="Quick Boost Logo">
        </div>
        
        <h1 id="auth-title">Welcome</h1>
        <div class="sub-title" id="auth-subtitle">Sign in to save your workouts</div>

        <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; text-align: left; margin-bottom: 20px;">
          <label style="font-size: 0.85rem; color: #ffffff; font-weight: 600; margin-left: 5px; margin-bottom: 5px; display: block;">Email</label>
          <input type="email" id="auth-email" placeholder="your@email.com" style="margin-bottom: 15px;">
          
          <label style="font-size: 0.85rem; color: #ffffff; font-weight: 600; margin-left: 5px; margin-bottom: 5px; display: block;">Password</label>
          <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin-bottom: 20px;">
          
          <button class="white-btn" id="auth-action-btn" onclick="handleAuth()" style="margin-bottom: 10px;">Log In</button>
        </div>

        <button class="white-btn outline-btn" id="auth-toggle-btn" onclick="toggleAuthMode()" style="border: none !important; font-size: 0.95rem; text-decoration: underline;">
          Need an account? Sign Up
        </button>
      </div>
      
      <div id="screen-home" class="screen">
        <div class="home-hero-icon">
          <img src="./icon-192.png" alt="Quick Boost Logo">
        </div>
        <h1>Quick Boost</h1>
        <div class="sub-title">HIIT workouts to energize your day</div>
        <button class="white-btn" style="border-radius: 24px; padding: 20px 40px;" onclick="navTo('screen-workout-list', 'workout')">Get Started!</button>
      </div>

      <div id="screen-workout-list" class="screen">
        <h2>Choose Your Workout</h2>
        <div class="sub-title">Select your duration</div>
        <button class="white-btn" onclick="openCategory(2)">2 Minute Workouts</button>
        <button class="white-btn" onclick="openCategory(5)">5 Minute Workouts</button>
        <button class="white-btn" onclick="openCategory(10)">10 Minute Workouts</button>
        <button class="white-btn outline-btn" onclick="openCustomWorkouts()">Custom Workout</button>
      </div>

      <div id="screen-workout-category" class="screen">
        <h2 id="category-title">Workouts</h2>
        <div class="sub-title" id="category-sub">Select a routine to begin</div>
        <div id="category-list"></div>
        <button class="white-btn outline-btn" onclick="navTo('screen-workout-list', 'workout')" style="margin-top: 20px;">Back</button>
      </div>

      <div id="screen-custom-workouts" class="screen">
        <h2>Custom Workouts</h2>
        <div class="sub-title">Your personalized routines</div>
        
        <button class="white-btn" id="custom-random-btn" onclick="playRandomCustom()" style="color: #3B71F6; margin-bottom: 20px;">Surprise Me!</button>
        <button class="white-btn" style="background: rgba(255,255,255,0.2); color: #ffffff; border: 2px dashed #ffffff;" onclick="openBuilder()">+ Create New Workout</button>
        
        <div class="flex-row" style="margin-top: 15px;">
          <input type="text" id="custom-search" onkeyup="renderCustomList()" placeholder="Search workouts..." style="background: rgba(255,255,255,0.2); border:none; color:white; margin-bottom: 0; flex: 2;">
          <button class="white-btn" id="sort-btn" onclick="toggleSort()" style="margin-bottom: 0; flex: 1; padding: 10px; font-size: 0.9rem;">Sort: A-Z</button>
        </div>
        
        <div id="custom-list-container" style="margin-top: 15px; min-height: 200px;"></div>
        <button class="white-btn outline-btn" id="custom-workout-back-btn" onclick="navTo('screen-workout-list', 'workout')" style="margin-top: 20px;">Back</button>
      </div>

      <div id="screen-workout-summary" class="screen">
        <h2 id="summary-title" style="margin-bottom: 5px;">Workout Title</h2>
        <div id="summary-time" style="font-size: 1rem; color: rgba(255,255,255,0.8); font-weight: 500; margin-bottom: 20px;">Total Time: 0:00</div>
        
        <button class="white-btn" onclick="startWorkout()" style="border-radius: 24px; font-size: 1.3rem; margin-bottom: 25px;">Start Workout</button>
        
        <h3 style="margin-top: 0;">Exercise List</h3>
        <div id="summary-list" style="margin-bottom: 20px;"></div>
        
        <button class="white-btn outline-btn" onclick="goBackFromSummary()">Back</button>
      </div>

      <div id="screen-builder" class="screen">
        <h2>Workout Builder</h2>
        
        <input type="text" id="builder-title" placeholder="Workout Name (Tap here to name)" style="background: #ffffff; border: 2px solid #ffffff; color: #3B71F6; font-weight: 700; font-size: 1.1rem; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 5px;">
        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-bottom: 20px;">Add an exercise or rest below to start building.</div>
        
        <div id="builder-blocks" style="min-height: 150px; margin-bottom: 20px;"></div>
        <div class="flex-row">
          <button class="white-btn outline-btn" onclick="openExerciseLibrary()">+ Exercise</button>
          <button class="white-btn outline-btn" onclick="openRestInput()">+ Rest</button>
        </div>
        <button class="white-btn" onclick="saveCustomWorkout()">Save Workout</button>
        <button class="white-btn danger-btn" onclick="discardBuilder()">Discard</button>
      </div>

      <div id="screen-profile" class="screen">
        <h2>Your Profile</h2>
        <div class="sub-title">Track your progress</div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="stat-total-mins">0</div>
            <div class="stat-label">Mins This Month</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="stat-fav" style="font-size:1.1rem; line-height: 1.2;">None</div>
            <div class="stat-label">Favorite</div>
          </div>
        </div>

        <div class="streak-banner" id="profile-streak-display">0 day streak</div>
        <div class="calendar">
          <div class="cal-header">
            <button class="cal-nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
            <span id="cal-month-year">Month Year</span>
            <button class="cal-nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
          </div>
          <div class="cal-grid" id="cal-grid"></div>
        </div>
        
        <h3 style="text-align: center; border:none; margin-top: 30px;">Manage Content</h3>
        <div style="width: 100%; text-align: left; margin-bottom: 40px;">
          <button class="white-btn" onclick="openProfileWorkouts()" style="font-size: 0.95rem; padding: 15px; margin-bottom: 10px;">My Custom Workouts</button>
          <button class="white-btn" onclick="openProfileExercises()" style="font-size: 0.95rem; padding: 15px;">My Custom Exercises</button>
        </div>
      </div>

      <div id="screen-settings" class="screen">
        <h2>Settings</h2>
        <div class="sub-title">Customize your experience</div>
        
        <div style="width: 100%; text-align: left; margin-top: 20px;">
          
          <div class="settings-row" style="background: rgba(255,255,255,0.2);">
            <div><div class="settings-label">Account</div><div class="settings-sub" id="user-email-display">Not logged in</div></div>
            <button class="white-btn outline-btn" onclick="handleLogout()" style="width: auto; padding: 8px 15px; margin-bottom: 0; font-size: 0.85rem; border-color: rgba(255,255,255,0.5) !important;">Sign Out</button>
          </div>

          <div class="settings-row">
            <div><div class="settings-label">Prep Timer</div><div class="settings-sub">Countdown before start</div></div>
            <select id="set-prep" onchange="updateSettings()" style="width: auto; margin:0; padding: 5px 10px; background: #ffffff; color: #3B71F6; border:none; font-weight: bold;">
                <option value="5">5 seconds</option>
                <option value="10">10 seconds</option>
                <option value="15">15 seconds</option>
            </select>
          </div>
          <div class="settings-row">
            <div><div class="settings-label">Audio Beeps</div><div class="settings-sub">Play 3-second countdowns</div></div>
            <label class="switch"><input type="checkbox" id="set-audio" onchange="updateSettings()"><span class="slider"></span></label>
          </div>
          <div class="settings-row">
            <div><div class="settings-label">Haptic Feedback</div><div class="settings-sub">Vibrate on interval change</div></div>
            <label class="switch"><input type="checkbox" id="set-haptic" onchange="updateSettings()"><span class="slider"></span></label>
          </div>
          <div class="settings-row">
            <div><div class="settings-label">Daily Reminder</div><div class="settings-sub">Browser notification</div></div>
            <label class="switch"><input type="checkbox" id="set-remind" onchange="toggleReminder()"><span class="slider"></span></label>
          </div>
          <div class="settings-row" id="remind-time-row" style="display:none; background: rgba(255,255,255,0.2);">
            <div class="settings-label">Reminder Time</div>
            <input type="time" id="set-time" style="width: 160px; margin:0; padding:10px; cursor: pointer; background: #ffffff; color: #3B71F6; border:none; font-weight: bold;" onchange="updateSettings()">
          </div>
        </div>
      </div>

      <div id="screen-workout" class="screen">
        <div class="top-bar">
          <span id="elapsed-time">Elapsed: 0:00</span>
          <span id="workout-title">Workout Title</span>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
          <div id="exercise-name" class="exercise-title">Get Ready!</div>
          <div id="main-timer" class="timer-display">5</div>
        </div>

        <div class="controls">
          <button id="pause-btn" class="control-btn" onclick="togglePause()">Pause</button>
          <button class="control-btn" onclick="skipSegment()">Skip</button>
          <button class="control-btn end-btn" style="background: #ffffff; color: #ef4444;" onclick="endWorkout(false)">End</button>
        </div>
      </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
      <button class="nav-item active" id="nav-home" onclick="navTo('screen-home', 'home')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>Home</span>
      </button>
      <button class="nav-item" id="nav-workout" onclick="navTo('screen-workout-list', 'workout')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6.5 6.5l11 11"/><path d="M21 21l-1-1"/><path d="M3 3l1 1"/><path d="M18 22l4-4"/><path d="M2 6l4-4"/><path d="M3 10l7-7"/><path d="M14 21l7-7"/>
        </svg>
        <span>Workout</span>
      </button>
      <button class="nav-item" id="nav-profile" onclick="navTo('screen-profile', 'profile')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Profile</span>
      </button>
      <button class="nav-item" id="nav-settings" onclick="navTo('screen-settings', 'settings')">
        <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <span>Settings</span>
      </button>
    </div>
  </div>

  <div id="modal-profile-workouts" class="modal-overlay"><div class="modal-content"><h2>Custom Workouts</h2><button class="white-btn" onclick="openBuilderFromProfile()" style="font-size: 0.95rem; padding: 12px; margin-bottom: 15px;">+ Create New Workout</button><div class="modal-scroll" id="profile-workouts-container" style="height: 300px; min-height: 300px; flex: none;"></div><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-profile-workouts')">Close</button></div></div>
  <div id="modal-profile-ex" class="modal-overlay"><div class="modal-content"><h2>Custom Exercises</h2><button class="white-btn" onclick="openCreateExerciseModal()" style="font-size: 0.95rem; padding: 12px; margin-bottom: 15px;">+ Create New Exercise</button><div class="modal-scroll" id="profile-ex-container" style="height: 300px; min-height: 300px; flex: none;"></div><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-profile-ex')">Close</button></div></div>
  <div id="modal-exercise-lib" class="modal-overlay"><div class="modal-content"><h2>Select Exercise</h2><button class="white-btn" onclick="openCreateExerciseModal()" style="font-size: 0.95rem; padding: 12px; margin-bottom: 10px;">+ New Exercise</button><input type="text" id="lib-search" onkeyup="renderLibrary()" placeholder="Search exercises..."><div class="modal-scroll" id="lib-container" style="height: 300px; min-height: 300px; flex: none;"></div><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-exercise-lib')">Cancel</button></div></div>
  <div id="modal-create-ex" class="modal-overlay"><div class="modal-content" style="max-width: 320px;"><h2>New Exercise</h2><input type="text" id="new-ex-name" placeholder="Exercise name (e.g. Lunges)"><button class="white-btn" onclick="saveCustomExercise()">Save to Library</button><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-create-ex')">Cancel</button></div></div>
  <div id="modal-edit-ex" class="modal-overlay"><div class="modal-content" style="max-width: 320px;"><h2>Edit Exercise</h2><input type="text" id="edit-ex-name" placeholder="New exercise name"><button class="white-btn" onclick="saveEditedExercise()">Save Changes</button><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-edit-ex')">Cancel</button></div></div>
  <div id="modal-duration" class="modal-overlay"><div class="modal-content" style="max-width: 300px;"><h2 id="duration-title">Set Time</h2><div class="input-row"><div><label>Minutes</label><input type="number" id="dur-min" value="0" min="0" max="60"></div><div><label>Seconds</label><input type="number" id="dur-sec" id="dur-default" value="15" min="0" max="59"></div></div><button class="white-btn" onclick="confirmDuration()">Add to Workout</button><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-duration')">Cancel</button></div></div>
  <div id="modal-delete" class="modal-overlay"><div class="modal-content" style="max-width: 300px;"><h2>Are you sure?</h2><p style="margin-bottom: 20px; color: #64748b; font-weight: 500;">This will permanently delete this custom workout.</p><button class="white-btn danger-btn" onclick="confirmDelete()">Yes, Delete</button><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-delete')">No, Keep it</button></div></div>
  <div id="modal-delete-ex" class="modal-overlay"><div class="modal-content" style="max-width: 300px;"><h2>Are you sure?</h2><p style="margin-bottom: 20px; color: #64748b; font-weight: 500;">This will permanently delete this custom exercise.</p><button class="white-btn danger-btn" onclick="confirmDeleteExercise()">Yes, Delete</button><button class="white-btn" style="background: #f1f5f9; color: #64748b; box-shadow: none; margin-bottom: 0;" onclick="closeModal('modal-delete-ex')">No, Keep it</button></div></div>
  <div id="completion-modal" class="modal-overlay"><div class="modal-content" style="max-width: 300px;"><h2 style="font-size: 2.5rem; margin-bottom: 10px;">Great job!</h2><div id="modal-streak-msg" style="font-size: 1.1rem; font-weight: 700; color: #10b981; margin-bottom: 25px;"></div><button class="white-btn" onclick="closeModal('completion-modal'); navTo('screen-home', 'home');" style="margin-bottom: 0;">Close</button></div></div>

  <script>
    // 1. BUILT-IN DATA
    const workouts = {
      1: { title: 'Full Body Energy Boost', durationCategory: 5, sequence: [{ name: 'Jumping Jacks', duration: 40 }, { name: 'Rest', duration: 10 }, { name: 'Bodyweight Squats', duration: 40 }, { name: 'Rest', duration: 10 }, { name: 'Push-Ups', duration: 40 }, { name: 'Rest', duration: 10 }, { name: 'Mountain Climbers', duration: 40 }, { name: 'Rest', duration: 10 }, { name: 'High Knees', duration: 40 }] },
      2: { title: 'Core & Mobility Quick Reset', durationCategory: 5, sequence: [{ name: 'Plank Shoulder Taps', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Glute Bridges', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Side Lunges', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Bird-Dogs', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Standing Torso Twists', duration: 40 }] },
      3: { title: 'The 2-Minute Tabata Torch', durationCategory: 2, sequence: [{ name: 'Burpees', duration: 20 }, { name: 'Rest', duration: 10 }, { name: 'Jump Squats', duration: 20 }, { name: 'Rest', duration: 10 }, { name: 'Mountain Climbers', duration: 20 }, { name: 'Rest', duration: 10 }, { name: 'Speed Skaters', duration: 20 }, { name: 'Rest', duration: 10 }] },
      4: { title: 'The 2-Minute Desk Detox', durationCategory: 2, sequence: [{ name: 'Arm Circles', duration: 30 }, { name: 'Rest', duration: 10 }, { name: 'Toe Touches to Reach', duration: 30 }, { name: 'Rest', duration: 10 }, { name: 'Reverse Lunges', duration: 30 }, { name: 'Rest', duration: 10 }] },
      5: { title: '5-Minute Lower Body Burner', durationCategory: 5, sequence: [{ name: 'Sumo Squats', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Forward Lunges', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Glute Bridge Pulses', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Calf Raises', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Jump Lunges', duration: 45 }, { name: 'Rest', duration: 15 }] },
      6: { title: '10-Minute Total Body Fire', durationCategory: 10, sequence: [{ name: 'Inchworms', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Bicycle Crunches', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Squat to Knee Drive', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Plank Jacks', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'High Plank Hold', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Inchworms', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Bicycle Crunches', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Squat to Knee Drive', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'Plank Jacks', duration: 45 }, { name: 'Rest', duration: 15 }, { name: 'High Plank Hold', duration: 45 }, { name: 'Rest', duration: 15 }] },
      7: { title: '10-Min Core & Cardio Knockout', durationCategory: 10, sequence: [{ name: 'High Knees', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Russian Twists', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Jumping Jacks', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Leg Raises', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Burpees', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'High Knees', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Russian Twists', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Jumping Jacks', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Leg Raises', duration: 40 }, { name: 'Rest', duration: 20 }, { name: 'Burpees', duration: 40 }, { name: 'Rest', duration: 20 }] }
    };

    const exerciseLibrary = [
      "Arm Circles", "Bear Crawl", "Bicycle Crunches", "Bird-Dogs", "Box Jumps", "Burpees", "Butt Kicks", 
      "Calf Raises", "Cat-Cow", "Child's Pose", "Dead Bug", "Diamond Push-Ups", "Downward Dog", "Flutter Kicks", 
      "Forward Lunges", "Glute Bridge Pulses", "Glute Bridges", "High Knees", "High Plank Hold", "Inchworms", 
      "Jump Lunges", "Jump Rope", "Jump Squats", "Jumping Jacks", "Leg Raises", "Mountain Climbers", "Pike Push-Ups", 
      "Plank", "Plank Jacks", "Plank Shoulder Taps", "Push-Ups", "Reverse Lunges", "Russian Twists", "Side Lunges", 
      "Side Plank", "Sit-Ups", "Skaters", "Speed Skaters", "Squat to Knee Drive", "Squats (Bodyweight)", 
      "Standing Torso Twists", "Sumo Squats", "Toe Touches to Reach", "Tricep Dips", "V-Ups", "Wall Sit", "Wide Push-Ups"
    ];

    // 2. LOCAL STORAGE & GLOBAL STATE (Changed to 'var' to allow cloud syncing)
    var isSignUpMode = false;
    var loggedDates = JSON.parse(localStorage.getItem('qb_logs')) || [];
    var customWorkouts = JSON.parse(localStorage.getItem('qb_customs')) || [];
    var customExercises = JSON.parse(localStorage.getItem('qb_custom_ex')) || [];
    var qbSettings = JSON.parse(localStorage.getItem('qb_settings')) || { audio: true, haptic: true, reminders: false, time: "08:00", prepTime: 5 };
    var qbStats = JSON.parse(localStorage.getItem('qb_stats')) || { workoutHistory: {}, monthlySeconds: {} };
    if (!qbStats.monthlySeconds) qbStats.monthlySeconds = {};

    var currentWorkout = null, currentSeqIndex = 0, phase = 'prep';
    var timeLeft = 0, totalElapsed = 0, timerInterval = null, isRunning = false;
    var currentCalDate = new Date();
    var sortAscending = true;
    var workoutToDelete = null, exerciseToDelete = null;
    var buildSequence = [], pendingName = "", editingWorkoutId = null, editingExerciseName = null, builderSource = 'workout-list';
    var pendingWorkoutId = null, pendingIsCustom = false; 

    // --- CLOUD SYNCING FUNCTION ---
    async function syncDataToCloud() {
      if (window.auth && window.auth.currentUser && window.db) {
        const uid = window.auth.currentUser.uid;
        try {
          await window.setDoc(window.doc(window.db, "users", uid), {
            customWorkouts: customWorkouts,
            customExercises: customExercises,
            qbSettings: qbSettings,
            qbStats: qbStats,
            loggedDates: loggedDates
          }, { merge: true });
        } catch (e) {
          console.error("Cloud sync failed: ", e);
        }
      }
    }

    // --- AUTHENTICATION UI LOGIC ---
    function toggleAuthMode() {
      isSignUpMode = !isSignUpMode;
      if (isSignUpMode) {
        document.getElementById('auth-title').innerText = "Create Account";
        document.getElementById('auth-subtitle').innerText = "Join to sync your progress";
        document.getElementById('auth-action-btn').innerText = "Sign Up";
        document.getElementById('auth-toggle-btn').innerText = "Already have an account? Log In";
      } else {
        document.getElementById('auth-title').innerText = "Welcome Back";
        document.getElementById('auth-subtitle').innerText = "Sign in to save your workouts";
        document.getElementById('auth-action-btn').innerText = "Log In";
        document.getElementById('auth-toggle-btn').innerText = "Need an account? Sign Up";
      }
    }

    // 3. UTILITIES & HARDWARE 
    function getFormattedDate(dateObj) {
      const offset = dateObj.getTimezoneOffset() * 60000; 
      return (new Date(dateObj - offset)).toISOString().split('T')[0];
    }
    
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60); const s = seconds % 60; 
      return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function playBeep() {
      if(!qbSettings.audio) return;
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
      } catch(e) {}
    }

    function triggerVibe() {
      if(qbSettings.haptic && navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    // 4. SETTINGS
    function loadSettingsUI() {
      document.getElementById('set-audio').checked = qbSettings.audio;
      document.getElementById('set-haptic').checked = qbSettings.haptic;
      document.getElementById('set-remind').checked = qbSettings.reminders;
      document.getElementById('set-time').value = qbSettings.time;
      
      const prepSelect = document.getElementById('set-prep');
      if(prepSelect) prepSelect.value = qbSettings.prepTime !== undefined ? qbSettings.prepTime : 5;
      
      document.getElementById('remind-time-row').style.display = qbSettings.reminders ? "flex" : "none";
    }

    function updateSettings() {
      qbSettings.audio = document.getElementById('set-audio').checked;
      qbSettings.haptic = document.getElementById('set-haptic').checked;
      qbSettings.time = document.getElementById('set-time').value;
      qbSettings.prepTime = parseInt(document.getElementById('set-prep').value) || 5;
      localStorage.setItem('qb_settings', JSON.stringify(qbSettings));
      syncDataToCloud(); 
    }

    function toggleReminder() {
      qbSettings.reminders = document.getElementById('set-remind').checked;
      document.getElementById('remind-time-row').style.display = qbSettings.reminders ? "flex" : "none";
      if(qbSettings.reminders && "Notification" in window) Notification.requestPermission();
      updateSettings(); 
    }

    // 5. NAVIGATION & MODALS
    function navTo(screenId, tabName) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      
      document.getElementById('bottom-nav').style.display = (screenId === 'screen-workout' || screenId === 'screen-login') ? 'none' : 'flex';
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if(tabName && document.getElementById('nav-' + tabName)) {
        document.getElementById('nav-' + tabName).classList.add('active');
      }

      if (screenId === 'screen-profile') { updateProfileData(); }
      if (screenId === 'screen-settings') { loadSettingsUI(); }
    }
    
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // 6. STANDARD WORKOUT MENUS
    function openCategory(duration) {
      document.getElementById('category-title').innerText = `${duration} Minute Workouts`;
      document.getElementById('category-sub').innerText = `${duration} minutes is all you need`;
      
      const listContainer = document.getElementById('category-list');
      listContainer.innerHTML = ''; 
      
      const randBtn = document.createElement('button');
      randBtn.className = 'workout-card';
      randBtn.innerHTML = `
        <div class="card-text">
          <div class="card-title">Surprise Me!</div>
          <div class="card-sub">Play a random ${duration}-min workout</div>
        </div>
      `;
      randBtn.onclick = () => playRandomCategory(duration);
      listContainer.appendChild(randBtn);

      for (const [id, workout] of Object.entries(workouts)) {
        if (workout.durationCategory === duration) {
          const btn = document.createElement('button');
          btn.className = 'workout-card';
          btn.innerHTML = `
            <div class="card-text">
              <div class="card-title">${workout.title}</div>
            </div>
          `;
          btn.onclick = () => showWorkoutSummary(id, false);
          listContainer.appendChild(btn);
        }
      }
      navTo('screen-workout-category', 'workout');
    }

    function playRandomCategory(duration) {
      const validIds = Object.keys(workouts).filter(id => workouts[id].durationCategory === duration);
      if (validIds.length > 0) {
        const randomId = validIds[Math.floor(Math.random() * validIds.length)];
        showWorkoutSummary(randomId, false);
      }
    }

    function playRandomCustom() {
      if (customWorkouts.length > 0) {
        const randomWorkout = customWorkouts[Math.floor(Math.random() * customWorkouts.length)];
        showWorkoutSummary(randomWorkout.id, true);
      } else {
        alert("Create a custom workout first to use this feature!");
      }
    }

    // 7. CUSTOM WORKOUTS LIST 
    function openCustomWorkouts() {
      document.getElementById('custom-search').value = ""; renderCustomList(); navTo('screen-custom-workouts', 'workout');
    }

    function toggleSort() {
      sortAscending = !sortAscending; document.getElementById('sort-btn').innerText = sortAscending ? "Sort: A-Z" : "Sort: Z-A";
      renderCustomList();
    }

    function renderCustomList() {
      const container = document.getElementById('custom-list-container'); container.innerHTML = '';
      const query = document.getElementById('custom-search').value.toLowerCase();
      let filtered = customWorkouts.filter(w => w.title.toLowerCase().includes(query));
      filtered.sort((a, b) => { return a.title < b.title ? (sortAscending?-1:1) : (a.title > b.title ? (sortAscending?1:-1) : 0); });

      const randBtn = document.getElementById('custom-random-btn');
      if (filtered.length === 0) { 
        container.innerHTML = '<p style="color:rgba(255,255,255,0.7);">No custom workouts found.</p>'; 
        if(customWorkouts.length === 0) randBtn.style.display = 'none';
        return; 
      }
      
      randBtn.style.display = 'block';

      filtered.forEach(workout => {
        const item = document.createElement('div'); 
        item.className = 'workout-card';
        item.style.cursor = 'default';
        item.innerHTML = `
          <div class="card-text" style="cursor: pointer; flex: 1;" onclick="showWorkoutSummary('${workout.id}', true)">
            <div class="card-title">${workout.title}</div>
          </div>
          <div class="action-group" style="flex-shrink: 0;">
            <button class="icon-btn" onclick="editWorkoutFromList('${workout.id}', event)">‚úèÔ∏è</button>
            <button class="icon-btn icon-danger" onclick="promptDeleteWorkout('${workout.id}', event)">üóëÔ∏è</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function editWorkoutFromList(id, event) {
        event.stopPropagation();
        builderSource = 'workout-list';
        const workout = customWorkouts.find(w => w.id === id); if(!workout) return;
        editingWorkoutId = id; buildSequence = JSON.parse(JSON.stringify(workout.sequence));
        document.getElementById('builder-title').value = workout.title; renderBuilderBlocks(); navTo('screen-builder', 'workout');
    }

    function promptDeleteWorkout(id, event) {
        event.stopPropagation();
        workoutToDelete = id; 
        openModal('modal-delete');
    }

    // 8. SUMMARY SCREEN LOGIC
    function showWorkoutSummary(id, isCustom) {
      pendingWorkoutId = id;
      pendingIsCustom = isCustom;
      const workout = isCustom ? customWorkouts.find(w => w.id === id) : workouts[id];
      
      document.getElementById('summary-title').innerText = workout.title;
      const totalSecs = workout.sequence.reduce((sum, block) => sum + block.duration, 0);
      document.getElementById('summary-time').innerText = `Total Time: ${formatTime(totalSecs)}`;
      
      const list = document.getElementById('summary-list');
      list.innerHTML = '';
      workout.sequence.forEach(block => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `<div><div class="list-item-title">${block.name}</div><div class="list-item-sub">${formatTime(block.duration)}</div></div>`;
        list.appendChild(item);
      });
      
      navTo('screen-workout-summary', 'workout');
    }

    function goBackFromSummary() {
      if (pendingIsCustom) navTo('screen-custom-workouts', 'workout');
      else navTo('screen-workout-category', 'workout');
    }

    // 9. PROFILE: MANAGE WORKOUTS
    function openProfileWorkouts() { renderProfileWorkouts(); openModal('modal-profile-workouts'); }

    function renderProfileWorkouts() {
      const container = document.getElementById('profile-workouts-container'); container.innerHTML = '';
      if(customWorkouts.length === 0) { container.innerHTML = '<p style="color:#64748b; text-align:center;">No custom workouts created yet.</p>'; return; }

      let sorted = [...customWorkouts].sort((a,b) => a.title.localeCompare(b.title));
      sorted.forEach(workout => {
        const item = document.createElement('div'); item.className = 'list-item';
        const totalSecs = workout.sequence.reduce((sum, block) => sum + block.duration, 0);
        item.innerHTML = `<div><div class="list-item-title">${workout.title}</div><div class="list-item-sub">${workout.sequence.length} items ‚Ä¢ ${formatTime(totalSecs)} total</div></div>`;
        
        const actions = document.createElement('div'); actions.className = 'action-group';
        const editBtn = document.createElement('button'); editBtn.className = 'icon-btn'; editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.onclick = () => editWorkoutFromProfile(workout.id);
        const delBtn = document.createElement('button'); delBtn.className = 'icon-btn icon-danger'; delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.onclick = () => { workoutToDelete = workout.id; openModal('modal-delete'); };
        
        actions.appendChild(editBtn); actions.appendChild(delBtn); item.appendChild(actions); container.appendChild(item);
      });
    }

    function confirmDelete() {
      customWorkouts = customWorkouts.filter(w => w.id !== workoutToDelete);
      localStorage.setItem('qb_customs', JSON.stringify(customWorkouts));
      syncDataToCloud(); 
      closeModal('modal-delete');
      if (document.getElementById('modal-profile-workouts').classList.contains('active')) renderProfileWorkouts();
      if (document.getElementById('screen-custom-workouts').classList.contains('active')) renderCustomList();
    }

    // 10. CUSTOM BUILDER
    function openBuilder() {
      builderSource = 'workout-list'; editingWorkoutId = null; buildSequence = [];
      document.getElementById('builder-title').value = ""; renderBuilderBlocks(); navTo('screen-builder', 'workout');
    }

    function openBuilderFromProfile() {
      closeModal('modal-profile-workouts'); builderSource = 'profile'; editingWorkoutId = null; buildSequence = [];
      document.getElementById('builder-title').value = ""; renderBuilderBlocks(); navTo('screen-builder', 'workout');
    }

    function editWorkoutFromProfile(id) {
      closeModal('modal-profile-workouts'); builderSource = 'profile';
      const workout = customWorkouts.find(w => w.id === id); if(!workout) return;
      editingWorkoutId = id; buildSequence = JSON.parse(JSON.stringify(workout.sequence));
      document.getElementById('builder-title').value = workout.title; renderBuilderBlocks(); navTo('screen-builder', 'workout');
    }

    function renderBuilderBlocks() {
      const container = document.getElementById('builder-blocks'); container.innerHTML = '';
      if (buildSequence.length === 0) { container.innerHTML = '<p style="color:rgba(255,255,255,0.7); font-size: 0.9rem;">Add an exercise or rest below to start building.</p>'; return; }

      buildSequence.forEach((block, index) => {
        const item = document.createElement('div'); item.className = 'list-item';
        item.innerHTML = `<div><div class="list-item-title">${block.name}</div><div class="list-item-sub">${formatTime(block.duration)}</div></div>`;

        const actions = document.createElement('div'); actions.className = 'action-group';
        if (index > 0) {
          const upBtn = document.createElement('button'); upBtn.className = 'icon-btn'; upBtn.innerHTML = '‚Üë';
          upBtn.onclick = () => moveBlock(index, -1); actions.appendChild(upBtn);
        }
        if (index < buildSequence.length - 1) {
          const downBtn = document.createElement('button'); downBtn.className = 'icon-btn'; downBtn.innerHTML = '‚Üì';
          downBtn.onclick = () => moveBlock(index, 1); actions.appendChild(downBtn);
        }
        const delBtn = document.createElement('button'); delBtn.className = 'icon-btn icon-danger'; delBtn.innerHTML = '‚úï';
        delBtn.onclick = () => { buildSequence.splice(index, 1); renderBuilderBlocks(); }; actions.appendChild(delBtn);

        item.appendChild(actions); container.appendChild(item);
      });
    }

    function moveBlock(index, dir) {
      const temp = buildSequence[index]; buildSequence[index] = buildSequence[index + dir]; buildSequence[index + dir] = temp; renderBuilderBlocks();
    }

    function openRestInput() {
      pendingName = "Rest"; openModal('modal-duration'); document.getElementById('duration-title').innerText = "Duration: Rest";
      document.getElementById('dur-min').value = "0"; document.getElementById('dur-sec').value = "15";
    }

    function confirmDuration() {
      const m = parseInt(document.getElementById('dur-min').value) || 0; const s = parseInt(document.getElementById('dur-sec').value) || 0;
      const totalSecs = (m * 60) + s;
      if (totalSecs > 0) { buildSequence.push({ name: pendingName, duration: totalSecs }); renderBuilderBlocks(); }
      closeModal('modal-duration');
    }

    function saveCustomWorkout() {
      const titleInput = document.getElementById('builder-title');
      const title = titleInput.value.trim();

      if (!title) { 
          titleInput.style.border = '2px solid #ef4444';
          titleInput.style.background = '#fee2e2';
          alert("Oops! Please name your workout in the white box at the top of the screen before saving."); 
          setTimeout(() => {
              titleInput.style.border = '2px solid #ffffff';
              titleInput.style.background = '#ffffff';
          }, 2500);
          return; 
      }
      if (buildSequence.length === 0) { alert("Please add at least one exercise."); return; }

      if (editingWorkoutId) {
        const index = customWorkouts.findIndex(w => w.id === editingWorkoutId);
        if(index > -1) { customWorkouts[index].title = title; customWorkouts[index].sequence = [...buildSequence]; }
        editingWorkoutId = null;
      } else {
        const newWorkout = { id: 'c_' + Date.now(), title: title, sequence: [...buildSequence] };
        customWorkouts.push(newWorkout);
      }
      localStorage.setItem('qb_customs', JSON.stringify(customWorkouts));
      syncDataToCloud(); 
      
      if (builderSource === 'profile') { navTo('screen-profile', 'profile'); openProfileWorkouts(); } else openCustomWorkouts();
    }

    function discardBuilder() {
      editingWorkoutId = null; if (builderSource === 'profile') { navTo('screen-profile', 'profile'); openProfileWorkouts(); } else openCustomWorkouts();
    }

    // 11. LIBRARY & EXERCISES MANAGE
    function openExerciseLibrary() { document.getElementById('lib-search').value = ""; renderLibrary(); openModal('modal-exercise-lib'); }

    function renderLibrary() {
      const container = document.getElementById('lib-container'); container.innerHTML = '';
      const query = document.getElementById('lib-search').value.toLowerCase();
      
      let allExercises = exerciseLibrary.map(name => ({ name: name, custom: false }));
      customExercises.forEach(name => allExercises.push({ name: name, custom: true }));
      let filtered = allExercises.filter(ex => ex.name.toLowerCase().includes(query));
      filtered.sort((a, b) => a.name.localeCompare(b.name));

      filtered.forEach(ex => {
        const item = document.createElement('div'); item.className = 'list-item'; item.style.cursor = 'pointer';
        let contentHtml = `<div class="list-item-title">${ex.name}`;
        if (ex.custom) contentHtml += `<span class="custom-badge">CUSTOM</span>`;
        item.innerHTML = contentHtml + `</div>`;

        item.onclick = () => {
          closeModal('modal-exercise-lib'); pendingName = ex.name; openModal('modal-duration');
          document.getElementById('duration-title').innerText = `Duration: ${ex.name}`;
        };
        container.appendChild(item);
      });
    }

    function openProfileExercises() { renderProfileExercises(); openModal('modal-profile-ex'); }

    function renderProfileExercises() {
      const container = document.getElementById('profile-ex-container'); container.innerHTML = '';
      if(customExercises.length === 0) { container.innerHTML = '<p style="color:#64748b; text-align:center;">No custom exercises.</p>'; return; }

      let sorted = [...customExercises].sort((a,b) => a.localeCompare(b));
      sorted.forEach(ex => {
        const item = document.createElement('div'); item.className = 'list-item';
        item.innerHTML = `<div class="list-item-title">${ex}</div>`;
        const actions = document.createElement('div'); actions.className = 'action-group';
        
        const editBtn = document.createElement('button'); editBtn.className = 'icon-btn'; editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.onclick = () => openEditExerciseModal(ex);
        const delBtn = document.createElement('button'); delBtn.className = 'icon-btn icon-danger'; delBtn.innerHTML = 'üóëÔ∏è';
        delBtn.onclick = () => { exerciseToDelete = ex; openModal('modal-delete-ex'); };
        
        actions.appendChild(editBtn); actions.appendChild(delBtn); item.appendChild(actions); container.appendChild(item);
      });
    }

    function openCreateExerciseModal() { document.getElementById('new-ex-name').value = ""; openModal('modal-create-ex'); }

    function saveCustomExercise() {
      const newName = document.getElementById('new-ex-name').value.trim();
      if (!newName) { alert("Enter a name."); return; }
      if (exerciseLibrary.includes(newName) || customExercises.includes(newName)) { alert("Exists."); return; }
      customExercises.push(newName); 
      localStorage.setItem('qb_custom_ex', JSON.stringify(customExercises)); 
      syncDataToCloud(); 
      
      closeModal('modal-create-ex');
      if (document.getElementById('modal-exercise-lib').classList.contains('active')) renderLibrary();
      if (document.getElementById('modal-profile-ex').classList.contains('active')) renderProfileExercises();
    }

    function openEditExerciseModal(oldName) {
      editingExerciseName = oldName; document.getElementById('edit-ex-name').value = oldName; openModal('modal-edit-ex');
    }

    function saveEditedExercise() {
      const newName = document.getElementById('edit-ex-name').value.trim();
      if (!newName || newName === editingExerciseName) { closeModal('modal-edit-ex'); return; }
      if (exerciseLibrary.includes(newName) || customExercises.includes(newName)) { alert("Name exists."); return; }
      const idx = customExercises.indexOf(editingExerciseName); if (idx > -1) customExercises[idx] = newName;
      localStorage.setItem('qb_custom_ex', JSON.stringify(customExercises));
      
      customWorkouts.forEach(workout => { workout.sequence.forEach(block => { if (block.name === editingExerciseName) block.name = newName; }); });
      localStorage.setItem('qb_customs', JSON.stringify(customWorkouts));
      
      syncDataToCloud(); 

      if (buildSequence.length > 0) { buildSequence.forEach(block => { if (block.name === editingExerciseName) block.name = newName; }); renderBuilderBlocks(); }
      closeModal('modal-edit-ex');
      if (document.getElementById('modal-profile-ex').classList.contains('active')) renderProfileExercises();
      if (document.getElementById('modal-exercise-lib').classList.contains('active')) renderLibrary();
    }

    function confirmDeleteExercise() {
      customExercises = customExercises.filter(ex => ex !== exerciseToDelete); 
      localStorage.setItem('qb_custom_ex', JSON.stringify(customExercises)); 
      syncDataToCloud(); 
      
      closeModal('modal-delete-ex');
      if (document.getElementById('modal-profile-ex').classList.contains('active')) renderProfileExercises();
      if (document.getElementById('modal-exercise-lib').classList.contains('active')) renderLibrary();
    }

    // 12. PROFILE PROGRESS
    function updateProfileData() {
      let streak = 0; let checkDate = new Date(); let todayStr = getFormattedDate(checkDate);
      checkDate.setDate(checkDate.getDate() - 1); let yesterdayStr = getFormattedDate(checkDate);
      let workingDateStr = loggedDates.includes(todayStr) ? todayStr : yesterdayStr;
      
      if (loggedDates.includes(workingDateStr)) {
        let currentCheck = new Date(workingDateStr + 'T00:00:00'); 
        while (true) {
          if (loggedDates.includes(getFormattedDate(currentCheck))) { streak++; currentCheck.setDate(currentCheck.getDate() - 1); } else break;
        }
      }
      document.getElementById('profile-streak-display').innerText = `${streak} day streak`;
      
      const currentMonthKey = getFormattedDate(new Date()).substring(0, 7);
      let monthSecs = 0;
      if (qbStats.monthlySeconds && qbStats.monthlySeconds[currentMonthKey]) {
          monthSecs = qbStats.monthlySeconds[currentMonthKey];
      }
      document.getElementById('stat-total-mins').innerText = Math.floor(monthSecs / 60);

      let fav = "None", maxCount = 0;
      for (const [title, count] of Object.entries(qbStats.workoutHistory)) {
        if(count > maxCount) { maxCount = count; fav = title; }
      }
      document.getElementById('stat-fav').innerText = fav;

      renderCalendar();
    }

    function changeMonth(direction) { currentCalDate.setMonth(currentCalDate.getMonth() + direction); renderCalendar(); }

    function renderCalendar() {
      const year = currentCalDate.getFullYear(); const month = currentCalDate.getMonth();
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`;

      const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => grid.innerHTML += `<div class="cal-day-name cal-day">${d}</div>`);
      const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;
      for (let i = 1; i <= daysInMonth; i++) {
        let isLogged = loggedDates.includes(getFormattedDate(new Date(year, month, i)));
        grid.innerHTML += `<div class="cal-day ${isLogged ? 'logged' : ''}">${i}</div>`;
      }
    }

    // 13. WORKOUT ENGINE
    function startWorkout() {
      const id = pendingWorkoutId;
      const isCustom = pendingIsCustom;
      currentWorkout = isCustom ? customWorkouts.find(w => w.id === id) : workouts[id];
      currentSeqIndex = 0; phase = 'prep'; 
      timeLeft = qbSettings.prepTime !== undefined ? qbSettings.prepTime : 5; 
      totalElapsed = 0; isRunning = true;
      document.getElementById('workout-title').innerText = currentWorkout.title; 
      document.getElementById('pause-btn').innerText = 'Pause';
      updateUI(); navTo('screen-workout', '');
      clearInterval(timerInterval); timerInterval = setInterval(timerTick, 1000);
    }

    function timerTick() {
      if (!isRunning) return;
      if (timeLeft > 1) {
        timeLeft--;
        if(timeLeft <= 3 && timeLeft > 0) playBeep();
      } else {
        triggerVibe();
        handleNextSegment();
      }
      if (phase === 'active') totalElapsed++;
      updateUI();
    }

    function handleNextSegment() {
      if (phase === 'prep') { phase = 'active'; timeLeft = currentWorkout.sequence[0].duration; } 
      else {
        if (currentSeqIndex + 1 < currentWorkout.sequence.length) {
          currentSeqIndex++; timeLeft = currentWorkout.sequence[currentSeqIndex].duration;
        } else endWorkout(true);
      }
      updateUI();
    }

    function togglePause() { isRunning = !isRunning; document.getElementById('pause-btn').innerText = isRunning ? 'Pause' : 'Resume'; }
    function skipSegment() { if (isRunning) { triggerVibe(); handleNextSegment(); } }

    function endWorkout(completed) {
      clearInterval(timerInterval); isRunning = false;
      if (completed) {
        const todayStr = getFormattedDate(new Date());
        if (!loggedDates.includes(todayStr)) { loggedDates.push(todayStr); loggedDates.sort(); localStorage.setItem('qb_logs', JSON.stringify(loggedDates)); }
        
        const currentMonthKey = todayStr.substring(0, 7);
        if (!qbStats.monthlySeconds) qbStats.monthlySeconds = {};
        qbStats.monthlySeconds[currentMonthKey] = (qbStats.monthlySeconds[currentMonthKey] || 0) + totalElapsed;
        
        qbStats.workoutHistory[currentWorkout.title] = (qbStats.workoutHistory[currentWorkout.title] || 0) + 1;
        localStorage.setItem('qb_stats', JSON.stringify(qbStats));
        
        syncDataToCloud();

        const streakMsg = document.getElementById('modal-streak-msg');
        let streak = 0; let checkDate = new Date(); let checkStr = getFormattedDate(checkDate);
        while(loggedDates.includes(checkStr)) { streak++; checkDate.setDate(checkDate.getDate() - 1); checkStr = getFormattedDate(checkDate); }
        
        streakMsg.innerText = streak > 1 ? `Congratulations on your ${streak} day streak!` : "";
        streakMsg.style.display = streak > 1 ? 'block' : 'none';
        
        openModal('completion-modal');
      } else navTo('screen-home', 'home');
    }

    function updateUI() {
      document.getElementById('main-timer').innerText = formatTime(timeLeft);
      document.getElementById('elapsed-time').innerText = `Elapsed: ${formatTime(totalElapsed)}`;
      const nameDisplay = document.getElementById('exercise-name'); 

      if (phase === 'prep') {
        nameDisplay.innerText = "Get Ready!"; 
      } else {
        const currentExercise = currentWorkout.sequence[currentSeqIndex];
        nameDisplay.innerText = currentExercise.name;
      }
    }

    // 15. INIT AND EXPOSE FUNCTIONS FOR FIREBASE
    loadSettingsUI();
    updateProfileData();
    renderCalendar(); 
    document.getElementById('bottom-nav').style.display = 'none';

    window.navTo = navTo;
    window.loadSettingsUI = loadSettingsUI;
    window.updateProfileData = updateProfileData;
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCblgsmMQZV3BCNW2toMgf97-bbhuvwROY",
      authDomain: "quick-boost-692e9.firebaseapp.com",
      projectId: "quick-boost-692e9",
      storageBucket: "quick-boost-692e9.firebasestorage.app",
      messagingSenderId: "496990176682",
      appId: "1:496990176682:web:51b271ee2d551bc79897d3",
      measurementId: "G-26BYSGW46R"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    window.auth = auth;
    window.db = db;
    window.doc = doc;
    window.setDoc = setDoc;

    window.handleAuth = async function() {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      const btn = document.getElementById('auth-action-btn');

      if (!email || !password) {
        alert("Please enter both an email and password.");
        return;
      }

      const isSignUp = document.getElementById('auth-title').innerText === "Create Account";
      btn.innerText = "Loading..."; 

      try {
        if (isSignUp) {
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          await setDoc(doc(db, "users", user.uid), {
            customWorkouts: [],
            customExercises: [],
            qbSettings: { audio: true, haptic: true, reminders: false, time: "08:00", prepTime: 5 },
            qbStats: { workoutHistory: {}, monthlySeconds: {} },
            loggedDates: []
          });
        } else {
          await signInWithEmailAndPassword(auth, email, password);
        }
        document.getElementById('auth-email').value = "";
        document.getElementById('auth-password').value = "";
        btn.innerText = isSignUp ? "Sign Up" : "Log In";
      } catch (error) {
        alert(error.message);
        btn.innerText = isSignUp ? "Sign Up" : "Log In";
      }
    };

    window.handleLogout = async function() {
      try {
        await signOut(auth);
      } catch (error) {
        console.error("Error signing out: ", error);
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('user-email-display').innerText = user.email;
        
        try {
            const docSnap = await getDoc(doc(db, "users", user.uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                if (data.customWorkouts) window.customWorkouts = data.customWorkouts;
                if (data.customExercises) window.customExercises = data.customExercises;
                if (data.qbSettings) window.qbSettings = data.qbSettings;
                if (data.qbStats) window.qbStats = data.qbStats;
                if (data.loggedDates) window.loggedDates = data.loggedDates;
                
                window.loadSettingsUI();
                window.updateProfileData();
            }
        } catch (e) {
            console.error("Error loading cloud data:", e);
        }

        if (document.getElementById('screen-login').classList.contains('active')) {
            window.navTo('screen-home', 'home');
        }
      } else {
        document.getElementById('user-email-display').innerText = "Not logged in";
        window.navTo('screen-login', null);
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered!'))
          .catch(err => console.log('Service Worker failed: ', err));
      });
    }
  </script>
</body>
</html>